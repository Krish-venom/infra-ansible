---
# deploy.yml
# Vars expected from Jenkins:
#   app_repo_url: Git URL of the app
#   app_branch:   Branch to deploy

- name: Deploy to Apache instances
  hosts: apache
  become: true
  vars:
    apache_root: /var/www/html
  tasks:
    - name: Install Apache and Git
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
        update_cache: true
      loop:
        - apache2
        - git

    - name: Remove Apache root (clean slate)
      ansible.builtin.file:
        path: "{{ apache_root }}"
        state: absent

    - name: Recreate Apache root
      ansible.builtin.file:
        path: "{{ apache_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: Clone application repo into Apache root
      ansible.builtin.git:
        repo: "{{ app_repo_url }}"
        dest: "{{ apache_root }}"
        version: "{{ app_branch }}"
        force: yes

    - name: Set permissions for Apache root
      ansible.builtin.file:
        path: "{{ apache_root }}"
        owner: www-data
        group: www-data
        mode: "0755"
        recurse: true

    - name: Enable & restart Apache
      ansible.builtin.service:
        name: apache2
        state: restarted
        enabled: true

- name: Deploy to Nginx instances
  hosts: nginx
  become: true
  vars:
    nginx_root: /usr/share/nginx/html
  tasks:
    - name: Install Nginx and Git
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
        update_cache: true
      loop:
        - nginx
        - git

    - name: Remove Nginx root (clean slate)
      ansible.builtin.file:
        path: "{{ nginx_root }}"
        state: absent

    - name: Recreate Nginx root
      ansible.builtin.file:
        path: "{{ nginx_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: Clone application repo into Nginx root
      ansible.builtin.git:
        repo: "{{ app_repo_url }}"
        dest: "{{ nginx_root }}"
        version: "{{ app_branch }}"
        force: yes

    - name: Set permissions for Nginx root
      ansible.builtin.file:
        path: "{{ nginx_root }}"
        owner: www-data
        group: www-data
        mode: "0755"
        recurse: true

    - name: Enable & restart Nginx
      ansible.builtin.service:
        name: nginx
        state: restarted
        enabled: true
