
---
- name: Configure and deploy web servers
  hosts: webservers
  become: true
  gather_facts: true

  vars:
    web_src: "{{ lookup('env', 'WEB_SOURCE_DIR') | default('../web-src', true) }}"
    web_root: "/var/www/html"
    use_rsync: true

  pre_tasks:
    - name: Validate web source exists in Jenkins workspace
      delegate_to: localhost
      run_once: true
      stat:
        path: "{{ web_src }}"
      register: websrc_stat

    - name: Fail if web source directory not found
      delegate_to: localhost
      run_once: true
      fail:
        msg: >
          Web source directory '{{ web_src }}' not found on Jenkins workspace.
          Ensure Jenkins checked out the Weather-site repo and WEB_SOURCE_DIR is set.
      when: not websrc_stat.stat.exists

  tasks:
    - name: Update apt cache (Debian/Ubuntu)
      apt:
        update_cache: yes
        cache_valid_time: 1800
      when: ansible_os_family == "Debian"

    - name: Install required packages (nginx, rsync)
      apt:
        name: [nginx, rsync]
        state: present
      when: ansible_os_family == "Debian"
      notify: restart nginx

    - name: Ensure NGINX service is enabled and running
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Ensure web root exists
      file:
        path: "{{ web_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Deploy website content using rsync (fast & removes stale files)
      synchronize:
        src: "{{ web_src }}/"
        dest: "{{ web_root }}/"
        rsync_opts:
          - "--delete"
      when: use_rsync
      notify: fix permissions

    - name: Deploy website content using copy (fallback)
      copy:
        src: "{{ web_src }}/"
        dest: "{{ web_root }}/"
        owner: www-data
        group: www-data
        mode: '0644'
      when: not use_rsync
      notify: fix permissions

    - name: Ensure index.html exists if empty repo (sanity page)
      copy:
        dest: "{{ web_root }}/index.html"
        content: |
          <!doctype html>
          <html>
            <head><meta charset="utf-8"/><title>Deployed via Ansible</title></head>
            <body><h1>âœ… Deployment Successful</h1><p>Host: {{ inventory_hostname }}</p></body>
          </html>
        owner: www-data
        group: www-data
        mode: '0644'
      when: not (websrc_stat.stat.isdir | default(false))
      notify: reload nginx

  handlers:
    - name: fix permissions
      file:
        path: "{{ web_root }}"
        owner: www-data
        group: www-data
        recurse: yes

    - name: reload nginx
      service:
        name: nginx
        state: reloaded

    - name: restart nginx
      service:
        name: nginx
        state: restarted
