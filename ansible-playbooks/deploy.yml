---
# deploy.yml
# Vars expected:
#   artifact_path: absolute path to app.tar.gz on the controller (Jenkins)

- name: Deploy to Apache instances
  hosts: apache
  become: true
  vars:
    apache_root: /var/www/html
  tasks:
    - name: Install Apache
      ansible.builtin.apt:
        name: apache2
        state: present
        update_cache: true

    - name: Ensure Apache root exists
      ansible.builtin.file:
        path: "{{ apache_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: Upload artifact
      ansible.builtin.copy:
        src: "{{ artifact_path }}"
        dest: /tmp/app.tar.gz
        mode: "0644"

    - name: Clean Apache root
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_fileglob:
        - "{{ apache_root }}/*"

    - name: Unpack into Apache root
      ansible.builtin.unarchive:
        src: /tmp/app.tar.gz
        dest: "{{ apache_root }}"
        remote_src: true
        owner: www-data
        group: www-data
        mode: "0644"

    - name: Enable & restart Apache
      ansible.builtin.service:
        name: apache2
        state: restarted
        enabled: true

- name: Deploy to Nginx instances
  hosts: nginx
  become: true
  vars:
    nginx_root: /usr/share/nginx/html
  tasks:
    - name: Install Nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: true

    - name: Ensure Nginx root exists
      ansible.builtin.file:
        path: "{{ nginx_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: Upload artifact
      ansible.builtin.copy:
        src: "{{ artifact_path }}"
        dest: /tmp/app.tar.gz
        mode: "0644"

    - name: Clean Nginx root
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_fileglob:
        - "{{ nginx_root }}/*"

    - name: Unpack into Nginx root
      ansible.builtin.unarchive:
        src: /tmp/app.tar.gz
        dest: "{{ nginx_root }}"
        remote_src: true
        owner: www-data
        group: www-data
        mode: "0644"

    - name: Enable & restart Nginx
      ansible.builtin.service:
        name: nginx
        state: restarted
        enabled: true
